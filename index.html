<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plan Prenatal Sincronizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Mismos estilos de antes... */
        :root { --color-primary: #52b788; --color-secondary: #a8dadc; --color-accent: #fbc4c4; --color-bg: #f8f8f8; --color-text: #2c3e50; --color-water: #4fc3f7; --color-cream: #ec4899; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--color-bg); color: var(--color-text); }
        .header-bg { background: linear-gradient(135deg, var(--color-primary) 0%, #38a3a5 100%); border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; }
        .pill-card { background-color: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border-left: 5px solid var(--color-primary); }
        .checked-row { background-color: #e6f7ee; text-decoration: line-through; opacity: 0.7; }
        .check-box, .check-box-cream { cursor: pointer; width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .check-box { border: 2px solid var(--color-primary); } .check-box.checked { background: var(--color-primary); color: white; }
        .cream-card { background-color: #fdf2f8; border-left: 5px solid var(--color-cream); }
        .check-box-cream { border: 2px solid var(--color-cream); } .check-box-cream.checked { background: var(--color-cream); color: white; }
        .checked-row-cream { background-color: #fbc4c4; text-decoration: line-through; opacity: 0.8; }
        .water-card-normal { background-color: #e3f2fd; border-left: 5px solid var(--color-water); }
        
        /* Pantalla de Login */
        #login-screen { position: fixed; inset: 0; background: var(--color-bg); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        #app-content { display: none; } /* Oculto hasta loguear */
    </style>
</head>
<body class="pb-20">

    <!-- PANTALLA DE LOGIN (NUEVO) -->
    <div id="login-screen">
        <div class="mb-8 p-6 bg-white rounded-full shadow-lg">
            <i data-lucide="baby" class="w-16 h-16 text-teal-500"></i>
        </div>
        <h1 class="text-2xl font-bold mb-2 text-gray-700">Mi Plan Prenatal</h1>
        <p class="text-gray-500 mb-8">Inicia sesi칩n para sincronizar tus datos entre PC y celular.</p>
        
        <button id="google-login-btn" class="flex items-center bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-gray-50 transition active:scale-95">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3">
            Entrar con Google
        </button>
        <p id="login-msg" class="mt-4 text-sm text-gray-400"></p>
    </div>

    <!-- CONTENIDO DE LA APP -->
    <div id="app-content">
        <!-- Encabezado -->
        <div class="header-bg p-6 mb-8 text-white text-center rounded-xl shadow-lg m-4 mt-0 pt-8">
            <div class="flex items-center justify-center space-x-2 mb-2">
                <i data-lucide="baby" class="w-8 h-8"></i>
                <h1 class="text-2xl font-bold">Mi Plan</h1>
            </div>
            <div class="flex justify-between items-end px-2">
                <p class="text-sm opacity-90 text-left">Hola, <span id="user-name">Mam치</span></p>
                <button onclick="window.doLogout()" class="text-xs bg-white/20 px-2 py-1 rounded hover:bg-white/30">Salir</button>
            </div>
        </div>

        <div class="max-w-4xl mx-auto px-4">
            
            <!-- Hidrataci칩n -->
            <div id="hydration-card" class="mb-8 p-4 rounded-xl shadow-md water-card-normal">
                <h2 class="text-xl font-semibold mb-2 flex items-center text-blue-700"><i data-lucide="droplet" class="w-5 h-5 mr-2"></i> Agua</h2>
                <div id="hydration-status" class="text-center p-2 rounded-lg text-lg font-bold bg-blue-100 text-blue-700 mb-4">...</div>
                <button onclick="window.markWaterTaken()" id="water-btn" class="w-full text-white font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center bg-blue-500 active:bg-blue-600 transition">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Marcar Vaso
                </button>
            </div>

            <!-- Crema -->
            <div class="mb-8 p-4 rounded-xl shadow-md cream-card">
                <h2 class="text-xl font-semibold mb-2 flex items-center text-pink-700"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Piel</h2>
                <div id="creamProgressDisplay" class="text-center p-2 rounded-lg text-sm bg-white/50 text-gray-600 mb-2">...</div>
                <div id="cream-list" class="space-y-2"></div>
            </div>

            <!-- Suplementos -->
            <div class="space-y-6">
                <h2 class="text-xl font-semibold flex items-center text-gray-700"><i data-lucide="pill" class="w-5 h-5 mr-2"></i> Suplementos</h2>
                <div class="pill-card p-4 rounded-xl shadow-md"><h3 class="text-lg font-bold mb-3 text-gray-700">游깬 Ayunas</h3><div id="ayunas-list" class="space-y-2"></div></div>
                <div class="pill-card p-4 rounded-xl shadow-md"><h3 class="text-lg font-bold mb-3 text-gray-700">游꼽 Desayuno</h3><div id="desayuno-list" class="space-y-2"></div></div>
                <div class="pill-card p-4 rounded-xl shadow-md"><h3 class="text-lg font-bold mb-3 text-gray-700">游볭 Almuerzo</h3><div id="almuerzo-list" class="space-y-2"></div></div>
                <div class="pill-card p-4 rounded-xl shadow-md"><h3 class="text-lg font-bold mb-3 text-gray-700">游깿 Cena</h3><div id="cena-list" class="space-y-2"></div></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Importamos GoogleAuthProvider y signInWithPopup
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACI칍N DE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCQ6mZFbPympKrLRPVyrANa-8B6NKWu9t8",
          authDomain: "plan-prenatal-cc.firebaseapp.com",
          projectId: "plan-prenatal-cc",
          storageBucket: "plan-prenatal-cc.firebasestorage.app",
          messagingSenderId: "1036192129718",
          appId: "1:1036192129718:web:2adacd2e21a9e24a82bc17"
        };
        // -----------------------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let userId = null;
        let appState = null;
        const todayDate = new Date().toISOString().slice(0, 10);
        
        // Estructura de datos
        const INITIAL_DATA = {
            supplements: { probiotic: false, le_1: false, dha_1: false, d3k2: false, le_2: false, choline: false, le_3: false, dha_2: false },
            waterState: new Array(9).fill(false),
            creamState: { cream_morning: false, cream_afternoon: false, cream_night: false }
        };

        const plan = [
            { id: 'probiotic', name: 'Probi칩tico', dose: '1 C치psula', meal: 'ayunas' },
            { id: 'le_1', name: 'Prenatal', dose: '2 C치psulas', meal: 'desayuno' },
            { id: 'dha_1', name: 'DHA', dose: '1 C치psula', meal: 'desayuno' },
            { id: 'd3k2', name: 'Vit D3+K2', dose: '1-2 Gotas', meal: 'desayuno' },
            { id: 'le_2', name: 'Prenatal', dose: '1 C치psula', meal: 'almuerzo' },
            { id: 'choline', name: 'Fosfatidilcolina', dose: '1 C치psula', meal: 'almuerzo' },
            { id: 'le_3', name: 'Prenatal', dose: '1 C치psula', meal: 'cena' },
            { id: 'dha_2', name: 'DHA', dose: '1 C치psula', meal: 'cena' },
        ];
        const creamTimes = [ { id: 'cream_morning', name: 'Ma침ana' }, { id: 'cream_afternoon', name: 'Tarde' }, { id: 'cream_night', name: 'Noche' }];

        // --- L칍GICA DE AUTENTICACI칍N ---
        
        // Bot칩n Login
        document.getElementById('google-login-btn').addEventListener('click', () => {
            document.getElementById('login-msg').textContent = "Abriendo ventana segura de Google...";
            signInWithPopup(auth, provider).catch((error) => {
                console.error(error);
                document.getElementById('login-msg').textContent = "Error al iniciar sesi칩n: " + error.message;
            });
        });

        // Bot칩n Logout
        window.doLogout = () => signOut(auth);

        // Escuchador de estado (Login/Logout)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario logueado
                userId = user.uid;
                document.getElementById('user-name').textContent = user.displayName ? user.displayName.split(' ')[0] : 'Mam치';
                
                // Ocultar login, mostrar app
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                
                startSync();
                lucide.createIcons();
            } else {
                // Usuario NO logueado
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
                userId = null;
            }
        });

        // --- SINCRONIZACI칍N Y L칍GICA APP (IGUAL QUE ANTES) ---

        function startSync() {
            const docRef = doc(db, `users/${userId}/dailyTracking/${todayDate}`);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    appState = docSnap.data();
                } else {
                    appState = INITIAL_DATA;
                    setDoc(docRef, { ...INITIAL_DATA, createdAt: serverTimestamp() });
                }
                renderAll();
            });
        }

        function updateDb(field, newData) {
            if (!userId || !appState) return;
            const docRef = doc(db, `users/${userId}/dailyTracking/${todayDate}`);
            updateDoc(docRef, { [field]: newData });
        }

        function renderAll() {
            // Render Suplementos
            ['ayunas', 'desayuno', 'almuerzo', 'cena'].forEach(m => document.getElementById(m+'-list').innerHTML = '');
            plan.forEach(item => {
                const isChecked = appState.supplements[item.id] || false;
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 mb-2 rounded-xl border border-gray-100 ${isChecked ? 'checked-row' : 'bg-white'}`;
                div.innerHTML = `
                    <div class="flex flex-col"><span class="font-medium text-sm text-gray-800">${item.name}</span><span class="text-xs text-gray-500">${item.dose}</span></div>
                    <div class="check-box ${isChecked ? 'checked' : ''}" onclick="window.toggleSup('${item.id}')">${isChecked ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}</div>
                `;
                document.getElementById(`${item.meal}-list`).appendChild(div);
            });

            // Render Crema
            const creamContainer = document.getElementById('cream-list');
            creamContainer.innerHTML = '';
            let creamCount = 0;
            creamTimes.forEach(item => {
                const isChecked = appState.creamState[item.id] || false;
                if(isChecked) creamCount++;
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-xl border border-gray-100 ${isChecked ? 'checked-row-cream' : 'bg-white'}`;
                div.innerHTML = `<span>${item.name}</span><div class="check-box-cream ${isChecked ? 'checked' : ''}" onclick="window.toggleCream('${item.id}')">${isChecked ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}</div>`;
                creamContainer.appendChild(div);
            });
            document.getElementById('creamProgressDisplay').textContent = `${creamCount} / 3 completadas`;

            // Render Agua
            const waterTaken = appState.waterState.filter(Boolean).length;
            const btn = document.getElementById('water-btn');
            document.getElementById('hydration-status').textContent = `${waterTaken} / 9 Vasos`;
            
            if (waterTaken >= 9) {
                btn.disabled = true;
                btn.textContent = "춰Meta cumplida!";
                btn.className = "w-full text-white font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center bg-gray-400 cursor-not-allowed";
            } else {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="plus" class="w-5 h-5 mr-2"></i> Marcar Vaso (${waterTaken + 1})`;
                btn.className = "w-full text-white font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center bg-blue-500 active:bg-blue-600 transition";
            }

            lucide.createIcons();
        }

        window.toggleSup = (id) => updateDb('supplements', { ...appState.supplements, [id]: !appState.supplements[id] });
        window.toggleCream = (id) => updateDb('creamState', { ...appState.creamState, [id]: !appState.creamState[id] });
        window.markWaterTaken = () => {
            const idx = appState.waterState.indexOf(false);
            if (idx !== -1) {
                const newState = [...appState.waterState];
                newState[idx] = true;
                updateDb('waterState', newState);
            }
        };
    </script>
</body>
</html>
