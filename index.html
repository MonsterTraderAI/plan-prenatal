<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plan Prenatal Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js para gr谩ficos bonitos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --color-primary: #52b788; --color-bg: #f8f9fa; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--color-bg); padding-bottom: 80px; }
        
        /* Estilos Base */
        .header-bg { background: linear-gradient(135deg, #52b788 0%, #38a3a5 100%); border-radius: 0 0 40px 40px; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 20px; padding: 16px; }
        
        /* Checkboxes */
        .check-box { width: 28px; height: 28px; border: 2px solid #52b788; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer;}
        .check-box.checked { background: #52b788; color: white; transform: scale(1.05); }
        .row-checked { text-decoration: line-through; opacity: 0.6; background-color: #f0fff4; }

        /* Navegaci贸n Inferior */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 12px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 50; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-size: 0.75rem; background: none; border: none; }
        .nav-item.active { color: #38a3a5; font-weight: bold; }
        .nav-item i { margin-bottom: 4px; }

        /* Vistas */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Login */
        #login-screen { position: fixed; inset: 0; background: var(--color-bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <!-- PANTALLA DE LOGIN -->
    <div id="login-screen">
        <div class="mb-6 p-6 bg-white rounded-full shadow-lg"><i data-lucide="baby" class="w-16 h-16 text-teal-500"></i></div>
        <h1 class="text-2xl font-bold mb-2 text-gray-700">Mi Plan Prenatal</h1>
        <button id="google-login-btn" class="mt-8 flex items-center bg-white border border-gray-300 text-gray-700 font-bold py-3 px-8 rounded-xl shadow hover:bg-gray-50">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3"> Entrar con Google
        </button>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div id="app-content" style="display:none;">
        
        <!-- HEADER COMN -->
        <div class="header-bg p-6 pb-10 mb-[-20px] text-white text-center shadow-lg">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-xl font-bold text-left">Hola, <span id="user-name">Mam谩</span></h1>
                    <p class="text-sm opacity-90 text-left" id="current-date-display">Cargando...</p>
                </div>
                <button onclick="window.doLogout()" class="text-xs bg-white/20 p-2 rounded-lg hover:bg-white/30"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
        </div>

        <div class="max-w-4xl mx-auto px-4 relative z-10">

            <!-- VISTA 1: TRACKER (DIARIO) -->
            <div id="view-tracker" class="view-section active">
                
                <!-- Resumen R谩pido -->
                <div class="card flex justify-between items-center bg-white/95 backdrop-blur">
                    <div class="text-center w-1/3 border-r border-gray-100">
                        <span class="block text-2xl font-bold text-blue-500" id="stat-water">0/9</span>
                        <span class="text-xs text-gray-400">Agua</span>
                    </div>
                    <div class="text-center w-1/3 border-r border-gray-100">
                        <span class="block text-2xl font-bold text-green-500" id="stat-pills">0%</span>
                        <span class="text-xs text-gray-400">Pills</span>
                    </div>
                    <div class="text-center w-1/3">
                        <span class="block text-2xl font-bold text-pink-500" id="stat-cream">0/3</span>
                        <span class="text-xs text-gray-400">Crema</span>
                    </div>
                </div>

                <!-- Hidrataci贸n -->
                <div class="card border-l-4 border-blue-400">
                    <h3 class="font-bold text-blue-800 flex items-center mb-3"><i data-lucide="droplet" class="w-5 h-5 mr-2"></i> Hidrataci贸n</h3>
                    <div class="flex flex-wrap gap-2 justify-center mb-4" id="water-bubbles">
                        <!-- Bubbles injected by JS -->
                    </div>
                    <button onclick="window.markWaterTaken()" id="water-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl shadow active:scale-95 transition">
                        + Agregar Vaso (250ml)
                    </button>
                </div>

                <!-- Listas de Suplementos -->
                <div id="meals-container" class="space-y-4"></div>

                <!-- Crema -->
                <div class="card border-l-4 border-pink-400 mt-4">
                    <h3 class="font-bold text-pink-800 flex items-center mb-2"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Piel</h3>
                    <div id="cream-list" class="space-y-2"></div>
                </div>

                <!-- nimo y Notas (NUEVO) -->
                <div class="card mt-4 border-l-4 border-purple-400">
                    <h3 class="font-bold text-purple-800 flex items-center mb-2"><i data-lucide="heart-pulse" class="w-5 h-5 mr-2"></i> 驴C贸mo te sientes?</h3>
                    <div class="flex justify-around mb-4">
                        <button onclick="window.setMood('good')" class="text-3xl hover:scale-125 transition grayscale mood-btn" id="mood-good"></button>
                        <button onclick="window.setMood('meh')" class="text-3xl hover:scale-125 transition grayscale mood-btn" id="mood-meh"></button>
                        <button onclick="window.setMood('bad')" class="text-3xl hover:scale-125 transition grayscale mood-btn" id="mood-bad">あ</button>
                    </div>
                    <textarea id="daily-notes" placeholder="Alg煤n s铆ntoma o nota para el doc..." class="w-full p-3 border rounded-lg text-sm bg-gray-50 focus:bg-white transition" rows="2" onchange="window.saveNotes(this.value)"></textarea>
                </div>
            </div>

            <!-- VISTA 2: DASHBOARD (HISTORIAL) -->
            <div id="view-dashboard" class="view-section">
                <div class="card mt-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-700">Progreso (ltimos 7 d铆as)</h2>
                    <div class="relative h-64 w-full">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-bold text-gray-700 mb-2">Historial de S铆ntomas</h3>
                    <div id="symptom-history" class="space-y-3 text-sm text-gray-600">
                        <p class="text-center italic text-gray-400">Cargando historial...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- NAVEGACIN INFERIOR -->
    <nav class="bottom-nav" id="bottom-nav" style="display:none;">
        <button class="nav-item active" onclick="switchTab('tracker')">
            <i data-lucide="check-square" class="w-6 h-6"></i>
            <span>Hoy</span>
        </button>
        <button class="nav-item" onclick="switchTab('dashboard')">
            <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
            <span>Progreso</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, getDoc, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACIN FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCQ6mZFbPympKrLRPVyrANa-8B6NKWu9t8",
          authDomain: "plan-prenatal-cc.firebaseapp.com",
          projectId: "plan-prenatal-cc",
          storageBucket: "plan-prenatal-cc.firebasestorage.app",
          messagingSenderId: "1036192129718",
          appId: "1:1036192129718:web:2adacd2e21a9e24a82bc17"
        };    
        // -----------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userId = null;
        let appState = null;
        let weeklyChartInstance = null;
        const todayStr = new Date().toISOString().slice(0, 10);

        // Configuraci贸n del Plan
        const plan = [
            { id: 'probiotic', name: 'Probi贸tico', dose: '1 cap', meal: 'ayunas', fullMeal: ' Ayunas' },
            { id: 'le_1', name: 'Prenatal', dose: '2 caps', meal: 'desayuno', fullMeal: ' Desayuno' },
            { id: 'dha_1', name: 'DHA', dose: '1 cap', meal: 'desayuno', fullMeal: ' Desayuno' },
            { id: 'd3k2', name: 'Vit D3+K2', dose: '1-2 gotas', meal: 'desayuno', fullMeal: ' Desayuno' },
            { id: 'le_2', name: 'Prenatal', dose: '1 cap', meal: 'almuerzo', fullMeal: ' Almuerzo' },
            { id: 'choline', name: 'Colina', dose: '1 cap', meal: 'almuerzo', fullMeal: ' Almuerzo' },
            { id: 'le_3', name: 'Prenatal', dose: '1 cap', meal: 'cena', fullMeal: ' Cena' },
            { id: 'dha_2', name: 'DHA', dose: '1 cap', meal: 'cena', fullMeal: ' Cena' },
        ];
        const creamTimes = [{id:'m', name:'Ma帽ana'}, {id:'t', name:'Tarde'}, {id:'n', name:'Noche'}];
        const INITIAL_DATA = {
            supplements: {}, 
            waterState: new Array(9).fill(false), 
            creamState: {}, 
            mood: null, 
            notes: ''
        };

        // --- AUTH ---
        const loginBtn = document.getElementById('google-login-btn');
        loginBtn.addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
        window.doLogout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-name').textContent = user.displayName?.split(' ')[0] || 'Mam谩';
                document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('bottom-nav').style.display = 'flex';
                
                initRealtimeListener();
                lucide.createIcons();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
                document.getElementById('bottom-nav').style.display = 'none';
            }
        });

        // --- REALTIME DATA (HOY) ---
        function initRealtimeListener() {
            const docRef = doc(db, `users/${userId}/dailyTracking/${todayStr}`);
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    appState = snap.data();
                    // Migraci贸n simple si faltan campos nuevos
                    if(!appState.mood) appState.mood = null;
                    if(!appState.notes) appState.notes = '';
                } else {
                    appState = INITIAL_DATA;
                    setDoc(docRef, { ...INITIAL_DATA, date: todayStr, createdAt: serverTimestamp() });
                }
                renderTracker();
            });
        }

        // --- RENDER TRACKER ---
        function renderTracker() {
            // 1. Stats Top
            const pillsTotal = plan.length;
            const pillsTaken = plan.filter(p => appState.supplements[p.id]).length;
            document.getElementById('stat-pills').textContent = Math.round((pillsTaken/pillsTotal)*100) + '%';
            
            const waterTaken = appState.waterState.filter(Boolean).length;
            document.getElementById('stat-water').textContent = `${waterTaken}/9`;
            
            const creamTaken = creamTimes.filter(c => appState.creamState[c.id]).length;
            document.getElementById('stat-cream').textContent = `${creamTaken}/3`;

            // 2. Agua Bubbles
            const bubblesContainer = document.getElementById('water-bubbles');
            bubblesContainer.innerHTML = '';
            appState.waterState.forEach((done, idx) => {
                const bubble = document.createElement('div');
                bubble.className = `w-8 h-8 rounded-full border-2 border-blue-300 flex items-center justify-center text-xs font-bold ${done ? 'bg-blue-400 text-white' : 'bg-white text-blue-300'}`;
                bubble.textContent = idx + 1;
                bubblesContainer.appendChild(bubble);
            });

            // 3. Suplementos Agrupados
            const mealsContainer = document.getElementById('meals-container');
            mealsContainer.innerHTML = '';
            const meals = ['ayunas', 'desayuno', 'almuerzo', 'cena'];
            
            meals.forEach(mealKey => {
                const items = plan.filter(p => p.meal === mealKey);
                if(items.length === 0) return;
                
                const card = document.createElement('div');
                card.className = "card";
                card.innerHTML = `<h3 class="font-bold text-gray-700 mb-3">${items[0].fullMeal}</h3><div class="space-y-3" id="group-${mealKey}"></div>`;
                mealsContainer.appendChild(card);
                
                const groupDiv = card.querySelector(`#group-${mealKey}`);
                items.forEach(item => {
                    const isChecked = appState.supplements[item.id];
                    const row = document.createElement('div');
                    row.className = `flex justify-between items-center p-2 rounded-lg ${isChecked ? 'row-checked' : ''}`;
                    row.innerHTML = `
                        <div><p class="font-medium text-gray-800">${item.name}</p><p class="text-xs text-gray-500">${item.dose}</p></div>
                        <div class="check-box ${isChecked ? 'checked' : ''}" onclick="window.toggleSup('${item.id}')"><i data-lucide="check" class="w-4 h-4"></i></div>
                    `;
                    groupDiv.appendChild(row);
                });
            });

            // 4. Crema
            const creamDiv = document.getElementById('cream-list');
            creamDiv.innerHTML = '';
            creamTimes.forEach(c => {
                const isChecked = appState.creamState[c.id];
                const row = document.createElement('div');
                row.className = `flex justify-between items-center p-2 rounded-lg ${isChecked ? 'row-checked' : ''}`;
                row.innerHTML = `<span>${c.name}</span><div class="check-box ${isChecked ? 'checked border-pink-400 bg-pink-400' : 'border-pink-300'}" onclick="window.toggleCream('${c.id}')"><i data-lucide="check" class="w-4 h-4"></i></div>`;
                creamDiv.appendChild(row);
            });

            // 5. Mood & Notes
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.add('grayscale'));
            if(appState.mood) {
                document.getElementById(`mood-${appState.mood}`)?.classList.remove('grayscale');
            }
            document.getElementById('daily-notes').value = appState.notes || '';
            
            lucide.createIcons();
        }

        // --- DASHBOARD LOGIC ---
        async function loadDashboard() {
            if(!userId) return;
            const labels = [];
            const dataPills = [];
            const dataWater = [];
            
            // Generar ultimos 7 dias
            const dates = [];
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                dates.push(d.toISOString().slice(0,10));
                labels.push(d.toLocaleDateString('es-ES', {weekday:'short'}));
            }

            const historyContainer = document.getElementById('symptom-history');
            historyContainer.innerHTML = '';

            // Query Firestore (Parallel fetches)
            const promises = dates.map(d => getDoc(doc(db, `users/${userId}/dailyTracking/${d}`)));
            const snapshots = await Promise.all(promises);

            snapshots.forEach((snap, index) => {
                if(snap.exists()) {
                    const d = snap.data();
                    // Calcular % Pills
                    const taken = plan.filter(p => d.supplements && d.supplements[p.id]).length;
                    dataPills.push((taken / plan.length) * 100);
                    
                    // Calcular % Water
                    const wTaken = (d.waterState || []).filter(Boolean).length;
                    dataWater.push((wTaken / 9) * 100);

                    // Historial Sintomas
                    if(d.mood || d.notes) {
                        const moodMap = {good: '', meh: '', bad: 'あ'};
                        const div = document.createElement('div');
                        div.className = "bg-gray-50 p-3 rounded-lg border-l-4 border-purple-300";
                        div.innerHTML = `
                            <div class="flex justify-between text-xs font-bold text-gray-500">
                                <span>${dates[index]}</span>
                                <span>${d.mood ? moodMap[d.mood] : ''}</span>
                            </div>
                            <p class="mt-1 text-gray-700 italic">"${d.notes || 'Sin notas'}"</p>
                        `;
                        historyContainer.appendChild(div);
                    }
                } else {
                    dataPills.push(0);
                    dataWater.push(0);
                }
            });

            if(historyContainer.innerHTML === '') historyContainer.innerHTML = '<p class="text-center text-gray-400">A煤n no hay notas registradas.</p>';

            renderChart(labels, dataPills, dataWater);
        }

        function renderChart(labels, pills, water) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            if(weeklyChartInstance) weeklyChartInstance.destroy();

            weeklyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Suplementos %', data: pills, backgroundColor: '#52b788', borderRadius: 4 },
                        { label: 'Hidrataci贸n %', data: water, backgroundColor: '#4fc3f7', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // --- GLOBAL ACTIONS ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`view-${tab}`).classList.add('active');
            // Encontrar boton activo (simple hack)
            const btns = document.querySelectorAll('.nav-item');
            if(tab === 'tracker') btns[0].classList.add('active');
            else {
                btns[1].classList.add('active');
                loadDashboard(); // Cargar datos al cambiar
            }
        };

        window.toggleSup = (id) => updateDb('supplements', { ...appState.supplements, [id]: !appState.supplements[id] });
        window.toggleCream = (id) => updateDb('creamState', { ...appState.creamState, [id]: !appState.creamState[id] });
        window.markWaterTaken = () => {
            const idx = appState.waterState.indexOf(false);
            if (idx !== -1) {
                const ns = [...appState.waterState]; ns[idx] = true;
                updateDb('waterState', ns);
            }
        };
        window.setMood = (m) => updateDb('mood', m);
        
        // Debounce para notas
        let timeout;
        window.saveNotes = (txt) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => updateDb('notes', txt), 1000);
        }

        function updateDb(field, val) {
            if(!userId) return;
            const ref = doc(db, `users/${userId}/dailyTracking/${todayStr}`);
            updateDoc(ref, { [field]: val });
        }
    </script>
</body>
</html>
