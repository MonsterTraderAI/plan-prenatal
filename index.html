<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Suplementación Prenatal Personalizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --color-primary: #52b788; 
            --color-secondary: #a8dadc;
            --color-accent: #fbc4c4;
            --color-bg: #f8f8f8;
            --color-text: #2c3e50;
            --color-water: #4fc3f7;
            --color-cream: #ec4899;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
        }
        .header-bg {
            background-color: var(--color-primary);
            background-image: linear-gradient(135deg, var(--color-primary) 0%, #38a3a5 100%);
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
        }
        .pill-card {
            background-color: white;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--color-primary);
        }
        .checked-row {
            background-color: #e6f7ee;
            text-decoration: line-through;
            opacity: 0.7;
        }
        .check-box {
            cursor: pointer;
            width: 24px;
            height: 24px;
            border: 2px solid var(--color-primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .check-box.checked {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
        .cream-card {
            background-color: #fdf2f8;
            border-left: 5px solid var(--color-cream);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .checked-row-cream {
            background-color: #fbc4c4;
            text-decoration: line-through;
            opacity: 0.8;
        }
        .check-box-cream {
            cursor: pointer;
            width: 24px;
            height: 24px;
            border: 2px solid var(--color-cream);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .check-box-cream.checked {
            background-color: var(--color-cream);
            border-color: var(--color-cream);
            color: white;
        }
        .water-card-normal {
            background-color: #e3f2fd;
            border-left: 5px solid var(--color-water);
            transition: background-color 0.5s, border-left 0.5s;
        }
        .water-card-alert {
            background-color: #fee2e2;
            border-left: 5px solid #ef4444;
            animation: pulse-border 1s infinite alternate;
        }
        @keyframes pulse-border {
            from { border-left-color: #ef4444; }
            to { border-left-color: #fca5a5; }
        }
    </style>
</head>
<body class="p-4 pb-20">

    <!-- Encabezado -->
    <div class="header-bg p-6 mb-8 text-white text-center rounded-xl shadow-lg">
        <div class="flex items-center justify-center space-x-2 mb-2">
            <i data-lucide="baby" class="w-8 h-8"></i>
            <h1 class="text-2xl font-bold">Mi Plan Prenatal</h1>
        </div>
        <p class="text-sm opacity-90">Rutina diaria. <span id="auth-status" class="font-semibold bg-white/20 px-2 py-1 rounded">Conectando...</span></p>
    </div>

    <div class="max-w-4xl mx-auto">

        <!-- Hidratación -->
        <div id="hydration-card" class="mb-8 p-4 rounded-xl shadow-md water-card-normal">
            <h2 class="text-xl font-semibold mb-2 flex items-center text-blue-700">
                <i data-lucide="droplet" class="w-5 h-5 mr-2"></i>
                Recordatorio de Hidratación
            </h2>
            <div id="hydration-status" class="text-center p-2 rounded-lg text-lg font-bold bg-blue-100 text-blue-700 mb-4">
                Cargando...
            </div>
            <div id="hydration-action" class="flex flex-col items-center">
                <p id="next-water-time" class="text-sm text-gray-600 mb-3"></p>
                <button onclick="window.markWaterTaken()" class="w-full text-white font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center bg-blue-500 hover:bg-blue-600 transition duration-150">
                    <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                    Marcar Vaso de Agua
                </button>
            </div>
        </div>
        
        <!-- Crema -->
        <div id="cream-tracker" class="mb-8 p-4 rounded-xl shadow-md cream-card">
            <h2 class="text-xl font-semibold mb-2 flex items-center text-pink-700">
                <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                Cuidado de la Piel
            </h2>
            <div id="creamProgressDisplay" class="text-center p-2 rounded-lg text-lg font-bold bg-gray-100 text-gray-700 mb-4">
                Cargando...
            </div>
            <div id="cream-list" class="space-y-2"></div>
        </div>

        <!-- Resumen -->
        <div class="mb-6 p-4 bg-white rounded-xl shadow-md border-t-4 border-t-gray-200">
            <h2 class="text-xl font-semibold mb-2 flex items-center">
                <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-blue-500"></i>
                Suplementos Diarios
            </h2>
            <div id="progressDisplay" class="text-center p-2 rounded-lg text-lg font-bold bg-gray-100 text-gray-700">
                Cargando...
            </div>
        </div>

        <!-- Tablas -->
        <div class="space-y-6">
            <div class="pill-card p-4 rounded-xl shadow-md">
                <h3 class="text-lg font-bold mb-3 flex items-center text-gray-700"><i data-lucide="sun-medium" class="w-5 h-5 mr-2 text-yellow-500"></i> Ayunas</h3>
                <div id="ayunas-list" class="space-y-2"></div>
            </div>

            <div class="pill-card p-4 rounded-xl shadow-md">
                <h3 class="text-lg font-bold mb-3 flex items-center text-gray-700"><i data-lucide="egg-fried" class="w-5 h-5 mr-2 text-amber-600"></i> Desayuno</h3>
                <div id="desayuno-list" class="space-y-2"></div>
            </div>

            <div class="pill-card p-4 rounded-xl shadow-md">
                <h3 class="text-lg font-bold mb-3 flex items-center text-gray-700"><i data-lucide="salad" class="w-5 h-5 mr-2 text-green-600"></i> Almuerzo</h3>
                <div id="almuerzo-list" class="space-y-2"></div>
            </div>

            <div class="pill-card p-4 rounded-xl shadow-md">
                <h3 class="text-lg font-bold mb-3 flex items-center text-gray-700"><i data-lucide="moon" class="w-5 h-5 mr-2 text-indigo-500"></i> Cena</h3>
                <div id="cena-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- Recomendaciones -->
        <div class="mt-8 p-6 bg-white rounded-xl shadow-xl border-t-4 border-t-red-400">
            <h2 class="text-xl font-bold mb-3 flex items-center text-red-600"><i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> Notas Importantes</h2>
            <ul class="space-y-3 text-sm list-disc pl-5 text-gray-700">
                <li><strong>Vitamina D:</strong> Si tomaste sol 15 min al mediodía sin bloqueador, omite las gotas.</li>
                <li><strong>Hierro:</strong> Se absorbe bien con el Prenatal (sin lácteos).</li>
                <li><strong>Agua:</strong> Toma 250ml con cada tanda de pastillas.</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCQ6mZFbPympKrLRPVyrANa-8B6NKWu9t8",
          authDomain: "plan-prenatal-cc.firebaseapp.com",
          projectId: "plan-prenatal-cc",
          storageBucket: "plan-prenatal-cc.firebasestorage.app",
          messagingSenderId: "1036192129718",
          appId: "1:1036192129718:web:2adacd2e21a9e24a82bc17"
        };
        // -----------------------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let appState = null;
        const todayDate = new Date().toISOString().slice(0, 10);
        
        const INITIAL_DATA = {
            supplements: { probiotic: false, le_1: false, dha_1: false, d3k2: false, le_2: false, choline: false, le_3: false, dha_2: false },
            waterState: new Array(9).fill(false),
            creamState: { cream_morning: false, cream_afternoon: false, cream_night: false }
        };

        const plan = [
            { id: 'probiotic', name: 'Probiótico', dose: '1 Cápsula', meal: 'ayunas' },
            { id: 'le_1', name: 'Prenatal', dose: '2 Cápsulas', meal: 'desayuno' },
            { id: 'dha_1', name: 'DHA', dose: '1 Cápsula', meal: 'desayuno' },
            { id: 'd3k2', name: 'Vit D3+K2', dose: '1-2 Gotas', meal: 'desayuno' },
            { id: 'le_2', name: 'Prenatal', dose: '1 Cápsula', meal: 'almuerzo' },
            { id: 'choline', name: 'Fosfatidilcolina', dose: '1 Cápsula', meal: 'almuerzo' },
            { id: 'le_3', name: 'Prenatal', dose: '1 Cápsula', meal: 'cena' },
            { id: 'dha_2', name: 'DHA', dose: '1 Cápsula', meal: 'cena' },
        ];

        const creamTimes = [
            { id: 'cream_morning', name: 'Mañana (9 AM)' },
            { id: 'cream_afternoon', name: 'Tarde (3 PM)' },
            { id: 'cream_night', name: 'Noche (9 PM)' },
        ];
        
        const waterTimes = ["08:00", "09:30", "11:00", "12:30", "14:00", "15:30", "17:00", "18:30", "20:00"];

        // 1. Autenticación y Carga de Datos
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('auth-status').textContent = "Guardado en nube";
                document.getElementById('auth-status').classList.add("text-green-200");
                startSync();
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error(error);
                    document.getElementById('auth-status').textContent = "Error Auth";
                });
            }
        });

        function startSync() {
            // Ruta simple: usuarios/ID/registros/FECHA
            const docRef = doc(db, `users/${userId}/dailyTracking/${todayDate}`);
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    appState = docSnap.data();
                } else {
                    appState = INITIAL_DATA;
                    setDoc(docRef, { ...INITIAL_DATA, createdAt: serverTimestamp() });
                }
                renderAll();
            });
        }

        function updateDb(field, newData) {
            if (!userId || !appState) return;
            const docRef = doc(db, `users/${userId}/dailyTracking/${todayDate}`);
            updateDoc(docRef, { [field]: newData });
        }

        // 2. UI Logic
        function renderAll() {
            renderSupplements();
            renderCream();
            checkHydration();
            lucide.createIcons();
        }

        function renderSupplements() {
            let count = 0;
            plan.forEach(item => {
                const isChecked = appState.supplements[item.id];
                if (isChecked) count++;
                const container = document.getElementById(`${item.meal}-list`);
                // Solo limpiamos si es la primera vez o cambio total, para evitar parpadeo podríamos optimizar, 
                // pero para este caso simple, limpiamos el contenedor antes de loop externo:
            });
            
            // Limpieza previa
            ['ayunas', 'desayuno', 'almuerzo', 'cena'].forEach(m => document.getElementById(m+'-list').innerHTML = '');

            plan.forEach(item => {
                const isChecked = appState.supplements[item.id] || false;
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-xl border border-gray-100 ${isChecked ? 'checked-row' : 'bg-white'}`;
                div.innerHTML = `
                    <div class="flex flex-col"><span class="font-medium text-sm text-gray-800">${item.name}</span><span class="text-xs text-gray-500">${item.dose}</span></div>
                    <div class="check-box ${isChecked ? 'checked' : ''}" onclick="window.toggleSup('${item.id}')">${isChecked ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}</div>
                `;
                document.getElementById(`${item.meal}-list`).appendChild(div);
            });
            
            const display = document.getElementById('progressDisplay');
            display.textContent = `${count} / ${plan.length} tomas`;
            display.className = `text-center p-2 rounded-lg text-lg font-bold ${count === plan.length ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`;
        }

        function renderCream() {
            const container = document.getElementById('cream-list');
            container.innerHTML = '';
            let count = 0;
            creamTimes.forEach(item => {
                const isChecked = appState.creamState[item.id] || false;
                if (isChecked) count++;
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-xl border border-gray-100 ${isChecked ? 'checked-row-cream' : 'bg-white'}`;
                div.innerHTML = `
                    <div class="flex flex-col"><span class="font-medium text-sm text-gray-800">${item.name}</span></div>
                    <div class="check-box-cream ${isChecked ? 'checked' : ''}" onclick="window.toggleCream('${item.id}')">${isChecked ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById('creamProgressDisplay').textContent = `${count} / 3 aplicaciones`;
        }

        function checkHydration() {
            const taken = appState.waterState.filter(Boolean).length;
            const now = new Date();
            const nowMins = now.getHours() * 60 + now.getMinutes();
            let nextIndex = waterTimes.findIndex((t, i) => {
                const [h, m] = t.split(':');
                return (h*60 + +m) > nowMins && !appState.waterState[i];
            });
            
            // Lógica simplificada de alerta
            const statusDiv = document.getElementById('hydration-status');
            statusDiv.textContent = `${taken} / 9 tomas`;
            
            const btn = document.querySelector('#hydration-action button');
            const card = document.getElementById('hydration-card');
            
            if (taken >= 9) {
                btn.disabled = true;
                btn.textContent = "¡Meta cumplida!";
                card.className = "mb-8 p-4 rounded-xl shadow-md bg-blue-50 border-l-4 border-blue-300";
                document.getElementById('next-water-time').textContent = "Bien hecho hoy.";
            } else {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> Marcar Vaso`;
                // Verificar si vamos tarde
                let pendingIndex = appState.waterState.indexOf(false);
                if (pendingIndex !== -1) {
                    const [h, m] = waterTimes[pendingIndex].split(':');
                    if (nowMins > (h*60 + +m + 15)) { // 15 min tolerancia
                        card.className = "mb-8 p-4 rounded-xl shadow-md water-card-alert";
                        document.getElementById('next-water-time').textContent = `Retraso: Debiste tomar a las ${waterTimes[pendingIndex]}`;
                    } else {
                        card.className = "mb-8 p-4 rounded-xl shadow-md water-card-normal";
                        document.getElementById('next-water-time').textContent = `Siguiente: ${waterTimes[pendingIndex]}`;
                    }
                }
            }
        }

        // Funciones Globales
        window.toggleSup = (id) => {
            const newState = { ...appState.supplements, [id]: !appState.supplements[id] };
            updateDb('supplements', newState);
        };

        window.toggleCream = (id) => {
            const newState = { ...appState.creamState, [id]: !appState.creamState[id] };
            updateDb('creamState', newState);
        };

        window.markWaterTaken = () => {
            const idx = appState.waterState.indexOf(false);
            if (idx !== -1) {
                const newState = [...appState.waterState];
                newState[idx] = true;
                updateDb('waterState', newState);
            }
        };
        
        // Revisar hora cada minuto
        setInterval(checkHydration, 60000);
    </script>
</body>
</html>
